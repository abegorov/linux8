# Практические навыки работы с ZFS

## Задание

1. Определить алгоритм с наилучшим сжатием:

    - определить какие алгоритмы сжатия поддерживает **ZFS** (**gzip, zle, lzjb, lz4**);
    - оздать 4 файловых системы на каждой применить свой алгоритм сжатия;
    - для сжатия использовать либо текстовый файл, либо группу файлов.

2. Определить настройки пула. С помощью команды **zfs import** собрать пул **ZFS**. Командами **zfs** определить настройки:

    - размер хранилища;
    - тип пул;
    - значение **recordsize**;
    - какое сжатие используется;
    - какая контрольная сумма используется.

3. Работа со снапшотами:

    - скопировать файл из удаленной директории;
    - восстановить файл локально с помощью **zfs receive**;
    - найти зашифрованное сообщение в файле **secret_message**.

4. Проверить работу дедупликации.

## Реализация

Задание сделано на **generic/centos9s**. **Vagrant** с версии **v2.2.10** поддерживает автоматическое подключение дисков в **VirtualBox**. Данная возможность поддерживается без дополнительных настроек с версии **2.4.1** или при задании переменной **VAGRANT_EXPERIMENTAL='disks'** в более ранних версиях. Для простоты **Vagrantfile** был переписан с учётом этих возможностей. После загрузки запускается скрипт **[provision.sh](https://github.com/abegorov/linux8/blob/main/provision.sh)**.

Скрипт **[provision.sh](https://github.com/abegorov/linux8/blob/main/provision.sh)**:

1. Ставит **jq**.
2. Ставит и запускается **zfs**, используется **DKMS** версия, так как **kmod** версия не ставится в **CentOS Stream 9** с текущей версией ядра.
3. С помощью **lsblk** и **jq** находит все диски, кроме системного.
4. Создаёт **zfs pool** с именем **tank** и **vdev** типа **draid3**. Используется 2 группы дисков, в каждой группе по 11 дисков под данные и 3 диска под **parity**, а также один диск как **hot spare**.
5. В переменную **COMPRESSIONS** добавляются все поддерживаемы **ZFS** алгоритмы сжатия. Для каждого алгоритма создаётся файловая система и в неё записывается текстовый лог **pg2600.converter.log**. После этого выводится отсортированный список значений атрибута **compressratio** для всех файловых систем. Видно, что наибольшую степень сжатия обеспечивает алгоритм **zstd-19**.
6. Импортируется пул **otus** и выводится доступное в нём место, его тип, значения **readonly** и **recordsize**, алгоритм сжатия и контрольных сумм.
7. Файловая система восстанавливается из предоставленного **snapshot**'а. С помощью **find** ищется файл **secret_message** и отображается его содержимое.
8. Проверяется работа дедупликации. Для этого в домашней директории создаётся файл **dedup_pool** и подключается, как пул **dedup** с включённой дедупликацией (с проверкой дедуплицируемых данных - **verify**), после чего лог **pg2600.converter.log** копируется в этот пул 20 раз.

## Результаты

- [вывод команды lsblk до решения](https://github.com/abegorov/linux8/blob/main/logs/lsblk-before.txt);
- [вывод команды lsblk после решения](https://github.com/abegorov/linux8/blob/main/logs/lsblk-after.txt);
- [вывод zpool status после решение](https://github.com/abegorov/linux8/blob/main/logs/zpool-status.txt);
- [вывод zpool list после решение](https://github.com/abegorov/linux8/blob/main/logs/zpool-list.txt);
- [вывод zfs list после решение](https://github.com/abegorov/linux8/blob/main/logs/zfs-list.txt);
- [степень сжатия для различных алгоримов ZFS](https://github.com/abegorov/linux8/blob/main/logs/compressratio.txt);
- [все атрибуты импортированного тома otus](https://github.com/abegorov/linux8/blob/main/logs/otus-props.txt);
- [нужные атрибуты импортированного тома otus](https://github.com/abegorov/linux8/blob/main/logs/otus-props-filtered.txt);
- [путь к файлу secret_message и его содержимое](https://github.com/abegorov/linux8/blob/main/logs/secret.txt);
- [содержимое пула dedup](https://github.com/abegorov/linux8/blob/main/logs/ls-dedup.txt).

## Запуск

Достаточно сделать **vagrant up**, при запуске будет автоматически запущен скрипт **[provision.sh](https://github.com/abegorov/linux8/blob/main/provision.sh)**, который сделает все указанные выше настройки. Протестировано в **Vagrant 2.3.7**.
